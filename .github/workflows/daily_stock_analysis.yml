name: æ¯æ—¥è‡ªåŠ¨é€‰è‚¡åˆ†æž

on:
  schedule:
    # UTC 08:10 = åŒ—äº¬æ—¶é—´ 16:10ï¼ˆè‚¡å¸‚æ”¶ç›˜åŽï¼‰
    # å‘¨ä¸€åˆ°å‘¨äº”è‡ªåŠ¨è¿è¡Œ
    - cron: '10 8 * * 1-5'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: false
        default: 'test_email'
        type: choice
        options:
          - test_email     # åªæµ‹è¯•é‚®ä»¶ï¼ˆæŽ¨èç¬¬ä¸€æ¬¡ç”¨ï¼‰
          - full_analysis  # å®Œæ•´åˆ†æž + å‘é‚®ä»¶

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: é…ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: pip install -r requirements.txt

      - name: åˆ›å»º .env é…ç½®æ–‡ä»¶
        run: |
          cat > .env << EOF
          EMAIL_ADDRESS=${{ secrets.EMAIL_ADDRESS }}
          EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
          EOF

      # â”€â”€ æ‰‹åŠ¨è§¦å‘ï¼šæµ‹è¯•é‚®ä»¶æ¨¡å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“§ æµ‹è¯•é‚®ä»¶å‘é€
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.mode == 'test_email' }}
        run: |
          echo "=== æµ‹è¯•é‚®ä»¶é€šè·¯ ==="
          python main.py --mode test

      # â”€â”€ æ‰‹åŠ¨è§¦å‘ï¼šå®Œæ•´åˆ†æžæ¨¡å¼ / å®šæ—¶è‡ªåŠ¨è¿è¡Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“Š è¿è¡Œé€‰è‚¡åˆ†æž
        if: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.mode == 'full_analysis') }}
        run: |
          echo "=== å¼€å§‹é€‰è‚¡åˆ†æž ==="
          python main.py --mode analysis

      - name: ðŸ“¬ å‘é€åˆ†æžæŠ¥å‘Šé‚®ä»¶
        if: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.mode == 'full_analysis') }}
        run: |
          echo "=== å‘é€é‚®ä»¶æŠ¥å‘Š ==="
          python main.py --mode email

      # â”€â”€ ä¸Šä¼ æŠ¥å‘Šå¤‡ä»½ï¼ˆæ‰€æœ‰æ¨¡å¼éƒ½æ‰§è¡Œï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ’¾ å¤‡ä»½æŠ¥å‘Šåˆ° Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: stock-report-${{ github.run_id }}
          path: logs/
          retention-days: 30
          if-no-files-found: ignore
